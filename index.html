<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D3.js Generator ‚Äì Live Editor MVP</title>

  <!-- Tailwind CSS CDN for modern dark styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- D3.js CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Monaco Editor via CDN (using require.js) -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>

  <style>
    body {
      background-color: #0f0f11;
      color: #e4e4e7;
      font-family: 'Inter', sans-serif;
    }
    /* Editor container height */
    #editorContainer {
      height: 400px;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
    }
    /* Visualization container */
    #visualization {
      height: 400px;
    }
  </style>
</head>
<body class="p-6">
<div class="max-w-6xl mx-auto space-y-8">
  <h1 class="text-3xl font-bold">üß† D3.js Generator ‚Äì Live Editor</h1>

  <!-- Example Prompts -->
  <section>
    <h2 class="text-xl font-semibold mb-2">Example Prompts</h2>
    <div id="exampleButtons" class="flex flex-wrap gap-2"></div>
  </section>

  <!-- Prompt Input -->
  <section class="space-y-4">
    <label for="promptInput" class="block text-lg">Prompt:</label>
    <input id="promptInput" type="text" placeholder="e.g., Create a bar chart of website traffic"
           class="w-full px-4 py-2 bg-zinc-900 text-white border border-zinc-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    <button id="generateButton"
            class="w-max bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-md transition-all duration-200">
      Generate Visualization
    </button>
  </section>

  <!-- Code Editor (Monaco) -->
  <section>
    <h2 class="text-xl font-semibold mb-2">üìù Code Editor</h2>
    <div id="editorContainer"></div>
  </section>

  <!-- Visualization Output -->
  <section>
    <h2 class="text-xl font-semibold mb-2">üìä Live Visualization</h2>
    <div id="visualization" class="border border-zinc-700 rounded-md bg-zinc-900 p-2"></div>
  </section>
</div>

<script>
  let editor, renderTimeout;

  // Example prompts data
  const examplePrompts = [
    "Create a bar chart showing website traffic for different browsers.",
    "Generate a pie chart of expenses: Rent 40%, Food 30%, etc.",
    "Create a line chart of temperature over 7 days.",
    "Create a scatter plot of study hours vs exam scores.",
    "Draw a red circle in the center of the visualization area."
  ];

  // Populate example prompt buttons
  function populateExampleButtons() {
    const container = document.getElementById('exampleButtons');
    examplePrompts.forEach(prompt => {
      const button = document.createElement('button');
      button.textContent = prompt;
      button.className = "px-4 py-1 text-sm bg-zinc-800 hover:bg-zinc-700 text-white rounded-full";
      button.onclick = () => document.getElementById('promptInput').value = prompt;
      container.appendChild(button);
    });
  }
  populateExampleButtons();

  // Configure Monaco Editor
  require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' } });
  require(['vs/editor/editor.main'], () => {
    editor = monaco.editor.create(document.getElementById('editorContainer'), {
      value: "// Your generated D3.js code will appear here\n",
      language: 'javascript',
      theme: 'vs-dark',
      automaticLayout: true,
      fontSize: 14,
      minimap: { enabled: false }
    });

    // When code changes, re-render the visualization (debounced to avoid rapid calls)
    editor.onDidChangeModelContent(() => {
      clearTimeout(renderTimeout);
      renderTimeout = setTimeout(renderVisualization, 500);
    });
  });

  // Render the visualization by executing the code from the editor.
  function renderVisualization() {
    const code = editor.getValue();
    const viz = document.getElementById('visualization');
    // Clear any previous visualization
    viz.innerHTML = "";
    d3.select("#visualization").select("svg").remove();
    try {
      new Function(code)();
    } catch (err) {
      console.error("Rendering error:", err);
      viz.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
    }
  }

  // Prompt generation handler
  document.getElementById('generateButton').addEventListener('click', async () => {
    const prompt = document.getElementById('promptInput').value.trim();
    if (!prompt) return alert("Enter a prompt.");

    // Clear visualization and show a loading message in the editor.
    d3.select("#visualization").select("svg").remove();
    document.getElementById('visualization').innerHTML = "";
    editor.setValue("// Generating code...");

    // NOTE: The API key below is insecure; do not expose your API keys in production.
    const groqApiKey = "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";

    try {
      const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${groqApiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama-3.3-70b-versatile",
          messages: [
            {
              role: "system",
              content: `You are a D3.js code generator. Output ONLY JavaScript code that appends an SVG to the element with the ID "visualization".`
            },
            { role: "user", content: prompt }
          ]
        })
      });

      const data = await response.json();
      console.log("API response:", data);
      const output = data.choices[0].message.content;
      // Extract code from Markdown-style formatting if present
      const codeMatch = output.match(/```javascript\s*([\s\S]*?)```/i);
      const extractedCode = codeMatch ? codeMatch[1].trim() : output.trim();

      // Set the generated code in the Monaco Editor
      editor.setValue(extractedCode);
      renderVisualization();

    } catch (error) {
      console.error("Error fetching code:", error);
      editor.setValue(`// Error: ${error.message}\n// Try using a different prompt or check your API key.`);
    }
  });
</script>
</body>
</html>
