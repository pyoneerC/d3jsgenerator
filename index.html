<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D3.js Generator ‚Äì Live Editor MVP</title>

  <!-- Tailwind CSS CDN for modern dark styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- D3.js CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Monaco Editor via CDN (using require.js) -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/src/dom-to-image.min.js"></script>

  <style>
    body {
      background-color: #0f0f11;
      color: #e4e4e7;
      font-family: 'Inter', sans-serif;
    }
    /* Editor container height */
    #editorContainer {
      height: 400px;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
    }
    /* Visualization container */
    #visualization {
      height: 400px;
    }
  </style>
</head>
<body class="p-6">
<div class="max-w-6xl mx-auto space-y-8">
  <h1 class="text-3xl font-bold">üß† D3.js Generator ‚Äì Live Editor</h1>

  <!-- Example Prompts -->
  <section>
    <h2 class="text-xl font-semibold mb-2">Example Prompts</h2>
    <div id="exampleButtons" class="flex flex-wrap gap-2"></div>
  </section>

  <!-- Prompt Input -->
  <section class="space-y-4">
    <label for="promptInput" class="block text-lg">Prompt:</label>
    <input id="promptInput" type="text" placeholder="e.g., Create a bar chart of website traffic"
           class="w-full px-4 py-2 bg-zinc-900 text-white border border-zinc-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    <button id="generateButton"
            class="w-max bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-md transition-all duration-200">
      Generate Visualization
    </button>
  </section>

  <!-- Code Editor (Monaco) -->
  <section>
    <h2 class="text-xl font-semibold mb-2">üìù Code Editor</h2>
    <div id="editorContainer"></div>
  </section>

  <!-- Visualization Output -->
  <section>
    <h2 class="text-xl font-semibold mb-2">üìä Live Visualization</h2>
    <div id="visualization" class="border border-zinc-700 rounded-md bg-zinc-900 p-2"></div>

    <!-- Centered Save Button -->
    <div class="flex justify-center mt-4">
      <button id="saveChartBtn"
              class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-md transition-all duration-200">
        üì• Save Chart as PNG
      </button>
    </div>
  </section>

<script>
  let editor, renderTimeout;

  // Example prompts data
  const examplePrompts = [
    "Create a bar chart showing website traffic for different browsers.",
    "Generate a pie chart of expenses: Rent 40%, Food 30%, Utilities 20%, Other 10%.",
    "Create a line chart of temperature over the past 7 days.",
    "Create a scatter plot of study hours vs exam scores.",
    "Draw a red circle in the center of the visualization area.",
    "Create a grouped bar chart comparing sales in Q1 and Q2 across product categories.",
    "Create a horizontal bar chart of top 10 programming languages by popularity.",
    "Create a donut chart showing market share of smartphone brands.",
    "Create a multi-line chart comparing CPU, GPU, and RAM usage over time.",
    "Create a heatmap showing correlation between different variables.",
    "Create a histogram of user ages in a dataset.",
    "Create an area chart of website signups over a 12-month period.",
    "Create a bubble chart showing population vs GDP for multiple countries.",
    "Create a radial chart (polar bar chart) of daily activity levels.",
    "Create a tree diagram showing an organizational structure.",
    "Create a force-directed graph of social network connections.",
    "Create a timeline showing major events in space exploration.",
    "Create a candlestick chart of stock price movements over a month.",
    "Create a step line chart showing pricing changes over time.",
    "Create a choropleth map of U.S. states colored by unemployment rate.",
    "Create a box plot showing distribution of salaries across industries.",
    "Create a waterfall chart illustrating company revenue breakdown.",
    "Create a stacked bar chart showing energy consumption by source (e.g., coal, solar, wind).",
    "Create a gauge chart indicating system health percentage.",
    "Create a lollipop chart of best-selling books with their sales numbers."
  ];

  document.getElementById("saveChartBtn").addEventListener("click", () => {
    const viz = document.getElementById("visualization");
    domtoimage.toPng(viz)
      .then(dataUrl => {
        const link = document.createElement("a");
        link.download = "d3-chart.png";
        link.href = dataUrl;
        link.click();
      })
      .catch(error => {
        console.error("Error saving chart as image:", error);
      });
  });


  // Populate example prompt buttons
  function populateExampleButtons() {
    const container = document.getElementById('exampleButtons');
    examplePrompts.forEach(prompt => {
      const button = document.createElement('button');
      button.textContent = prompt;
      button.className = "px-4 py-1 text-sm bg-zinc-800 hover:bg-zinc-700 text-white rounded-full";
      button.onclick = () => document.getElementById('promptInput').value = prompt;
      container.appendChild(button);
    });
  }
  populateExampleButtons();

  // Configure Monaco Editor
  require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' } });
  require(['vs/editor/editor.main'], () => {
    editor = monaco.editor.create(document.getElementById('editorContainer'), {
      value: "// Your generated D3.js code will appear here\n",
      language: 'javascript',
      theme: 'vs-dark',
      automaticLayout: true,
      fontSize: 14,
      minimap: { enabled: false }
    });

    // When code changes, re-render the visualization (debounced to avoid rapid calls)
    editor.onDidChangeModelContent(() => {
      clearTimeout(renderTimeout);
      renderTimeout = setTimeout(renderVisualization, 500);
    });
  });

  // Render the visualization by executing the code from the editor.
  function renderVisualization() {
    const code = editor.getValue();
    const viz = document.getElementById('visualization');
    // Clear any previous visualization
    viz.innerHTML = "";
    d3.select("#visualization").select("svg").remove();
    try {
      new Function(code)();
    } catch (err) {
      console.error("Rendering error:", err);
      viz.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
    }
  }

  // Prompt generation handler
  document.getElementById('generateButton').addEventListener('click', async () => {
    const prompt = document.getElementById('promptInput').value.trim();
    if (!prompt) return alert("Enter a prompt.");

    // Clear visualization and show a loading message in the editor.
    d3.select("#visualization").select("svg").remove();
    document.getElementById('visualization').innerHTML = "";
    editor.setValue("// Generating code...");

    // NOTE: The API key below is insecure; do not expose your API keys in production.
    const groqApiKey = "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";

    try {
      const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${groqApiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama-3.3-70b-versatile",
          messages: [
            {
              role: "system",
              content: `You are an elite D3.js visualization code generator. Your job is to output clean, consistent, and production-ready JavaScript code that renders high-quality visualizations inside the HTML element with ID "visualization".

Your generated code must follow these principles:

1. ‚úÖ **Best Practices & Structure**
   - Use D3.js v7.
   - Apply the standard margin convention.
   - Write clean, readable code with modular structure.
   - Use comments *only* when they improve clarity or customization.

2. üé® **Visual Design**
   - Create charts (bar, line, pie, scatter, etc.) that are visually balanced and easy to understand.
   - Include clearly labeled axes, chart titles, and data labels using consistent fonts and sizes.
   - Apply a modern and accessible color palette.
   - Avoid unnecessary elements or visual noise.

3. üß© **Customization & Modularity**
   - Define all core parameters (margins, dimensions, fonts, colors, tick formats, etc.) as top-level variables for easy adjustment.
   - Make the structure adaptable for different datasets and layout sizes.

4. üõ°Ô∏è **Stability & Execution**
   - Output only valid, runnable JavaScript.
   - Do not include any markdown, HTML, or extra commentary.
   - Ensure your code is robust and executes without errors in a browser context.
   - Assume data is hardcoded in the script.

5. ‚ú® **User Experience**
   - Incorporate tooltips or basic interactivity where it enhances clarity (e.g., on hover).
   - Keep transitions smooth and minimal when included.

Your mission is to generate stunning, effective, and uniform D3.js visualizations every single time. Deliver nothing less than top-tier, copy-paste-ready JavaScript.`
            },
            { role: "user", content: prompt }
          ]
        })
      });

      const data = await response.json();
      console.log("API response:", data);
      const output = data.choices[0].message.content;
      // Extract code from Markdown-style formatting if present
      const codeMatch = output.match(/```javascript\s*([\s\S]*?)```/i);
      const extractedCode = codeMatch ? codeMatch[1].trim() : output.trim();

      // Set the generated code in the Monaco Editor
      editor.setValue(extractedCode);
      renderVisualization();

    } catch (error) {
      console.error("Error fetching code:", error);
      editor.setValue(`// Error: ${error.message}\n// Try using a different prompt or check your API key.`);
    }
  });
</script>
</body>
</html>
